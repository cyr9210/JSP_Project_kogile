<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kogile.example.Mapper.PostMapper">
	<cache />
	<!-- 디스크립션 넘버 시퀀스,내용, 포스트넘바 -->
	<insert id="insertDescription" parameterType="DescriptionDTO">
		insert into description values(description_seq.nextval, #{d_contents}, #{p_no}) 
	</insert>
	
	<select id="descriptionList" parameterType="int" resultType="DescriptionDTO">
		select * from description where p_no = #{p_no}
	</select>
	
	<delete id="deleteDescription" parameterType="DescriptionDTO">
		delete from description where p_no=#{p_no}
	</delete>
	
	<update id="updateDescription" parameterType="DescriptionDTO">
		update description set d_contents = #{d_contents} where p_no = #{p_no}
	</update>
	<!-- 리플시퀀스, 내용, 작성일, 디스크립션 넘버,info넘버 -->
	
	<insert id="insertReply" parameterType="ReplyDTO">
		insert into reply values(reply_seq.nextval,#{r_contents},sysdate,#{p_no},#{info_no})
	</insert>
	
	<select id="replyList" parameterType="int" resultType="ReplyDTO">
		SELECT * from reply where p_no = #{p_no}
	</select>
	
	<delete id="deleteReply" parameterType="ReplyDTO">
		delete from reply where r_no=#{r_no} and info_no=#{info_no}
	</delete>
	
	<select id="replyUpdateSearch" parameterType="ReplyUpdateSearchDTO" resultType="ReplyDTO">
		select * from reply where r_no = #{search_r_no} and info_no = #{search_info_no}
	</select>
	<update id="updateReply" parameterType="ReplyDTO">
		update reply set r_contents = #{r_contents} 
				where r_no = #{r_no} and info_no = #{info_no}
	</update>
	
	<!-- 작성자때문에 멤버이름 가져오기 -->
	<select id="replyMemberList" parameterType="int" resultType="ReplyMemberDTO">
		select r.r_no, r.r_contents, r.r_date, r.p_no, r.info_no, e.exter_mem_name as name
    From reply r
    join prj_info p
    on r.info_no = p.info_no
    join invite i
    on p.invite_no = i.invite_no
    join total_member t
    on i.total_m_no = t.total_m_no
    join external_m_info e
    on t.exter_m_no = e.exter_m_no
    WHERE r.p_no =#{p_no}
	</select>
	<select id="replyMemberList2" parameterType="int" resultType="ReplyMemberDTO">
	select r.r_no, r.r_contents, r.r_date, r.p_no, r.info_no, m.member_name as name
    From reply r
    join prj_info p
    on r.info_no = p.info_no
    join invite i
    on p.invite_no = i.invite_no
    join total_member t
    on i.total_m_no = t.total_m_no
    join inter_m_info m
    on t.member_no = m.member_name
    WHERE r.p_no =#{p_no}
	</select>
	<!-- 태그 -->
	<select id="replyNum" resultType="int">
		select r_no from reply where ROWNUM=1 order by r_no desc
	</select>
	<insert id="insertTag" parameterType="TagDTO">
		INSERT INTO tag VALUES (TAG_SEQ.nextval, #{r_no},#{info_no})

	</insert>
	<!-- 태그 될 맴버 가져오기 -->
	<select id="tagMember" parameterType="int" resultType="TagDTO">
	select DISTINCT p.info_no,tm.total_m_no ,e.exter_mem_name as name
    from prj_info p
    join invite i
    on p.invite_no = i.invite_no
    join total_member tm
    on i.total_m_no = tm.total_m_no
    join external_m_info e
    on tm.exter_m_no = e.exter_m_no
    where i.pjt_no =#{pjt_no}
	</select>
	
	<select id="tagMember2" parameterType="int" resultType="TagDTO">
	select DISTINCT p.info_no,tm.total_m_no ,im.member_name as name
    from prj_info p
    join invite i
    on p.invite_no = i.invite_no
    join total_member tm
    on i.total_m_no = tm.total_m_no
    join inter_m_info im
    on tm.member_no = im.member_no
    where i.pjt_no =#{pjt_no}
	</select>
	<!-- 태그된 사람에게 알림 보내기 -->
	<insert id="insertTagNotice" parameterType="TagDTO">
		insert  into notice values(NOTICE_SEQ.nextval,null,#{tag_no},'태그존나알림',sysdate,#{total_m_no})
	</insert>
	<!-- 태그된 사람에게 알림 보내기 위해서 태그 넘버가져오기 -->
	<select id="tagNum" resultType="int">
		select tag_no from tag where ROWNUM=1 order by tag_no desc
	</select>
	<select id="tag_total_m_no" resultType="int" parameterType="TagDTO">
		select DISTINCT tm.total_m_no
    from prj_info p
    join invite i
    on p.invite_no = i.invite_no
    join total_member tm
    on i.total_m_no = tm.total_m_no
    where p.info_no =#{info_no}
	</select>
</mapper>